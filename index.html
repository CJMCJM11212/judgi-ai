<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 분쟁 해결사</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .btn {
            display: inline-block;
            font-weight: 500;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            user-select: none;
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .btn:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #6b7280;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        textarea {
            resize: vertical;
        }
        #loading-spinner div {
            border-color: #3b82f6 transparent transparent transparent;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">AI 분쟁 해결사</h1>
            <p class="text-gray-600 mt-2">AI가 당신의 갈등 상황을 객관적으로 분석해 드립니다.</p>
        </header>

        <!-- Page 1: A's Input -->
        <div id="page-a-input" class="page active">
            <div class="card">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">A님의 이야기</h2>
                <p class="text-gray-600 mb-6">상대방에게 전달하고 싶은 상황을 최대한 자세하고 솔직하게 작성해주세요. 작성되지 않은 내용은 판단에 고려되지 않습니다.</p>
                <textarea id="story-a" class="w-full p-3 border border-gray-300 rounded-lg h-48 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="여기에 상황을 입력하세요..."></textarea>
                <button id="submit-a" class="btn mt-6 w-full">상대방에게 보낼 링크 생성하기</button>
            </div>
        </div>

        <!-- Page 2: Link for B -->
        <div id="page-a-link" class="page">
            <div class="card text-center">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">링크 생성 완료!</h2>
                <p class="text-gray-600 mb-6">아래 링크를 복사하여 상대방(B)에게 전달해주세요. 상대방이 입장을 작성하면 AI 분석 결과를 확인할 수 있습니다.</p>
                <input id="link-for-b" type="text" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-center" readonly>
                <div class="mt-6 space-x-4">
                    <button id="copy-link" class="btn">링크 복사</button>
                    <button id="start-over-1" class="btn btn-secondary">처음부터 다시하기</button>
                </div>
            </div>
        </div>

        <!-- Page 3: B's Input -->
        <div id="page-b-input" class="page">
            <div class="card">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">B님의 이야기</h2>
                <p class="text-gray-600 mb-6">A님의 이야기를 확인하고, 당신의 입장을 솔직하게 작성해주세요. 마찬가지로 작성되지 않은 내용은 판단에 고려되지 않습니다.</p>
                
                <div class="mb-6">
                    <h3 class="font-bold text-lg text-gray-700 mb-2">A님의 이야기</h3>
                    <div id="story-a-display" class="w-full p-3 border border-gray-200 bg-gray-50 rounded-lg h-32 overflow-y-auto"></div>
                </div>

                <textarea id="story-b" class="w-full p-3 border border-gray-300 rounded-lg h-48 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="여기에 당신의 입장을 입력하세요..."></textarea>
                <button id="submit-b" class="btn mt-6 w-full">AI에게 최종 판단 요청하기</button>
            </div>
        </div>

        <!-- Page 4: Loading -->
        <div id="page-loading" class="page">
            <div class="card text-center">
                <div class="flex justify-center items-center mb-6">
                    <div id="loading-spinner" class="w-16 h-16 border-4 border-t-4 rounded-full animate-spin"></div>
                </div>
                <h2 class="text-2xl font-bold text-gray-700">AI가 분석 중입니다...</h2>
                <p class="text-gray-600 mt-2">두 분의 입장을 종합하여 객관적인 판단을 내리고 있습니다. 잠시만 기다려주세요.</p>
            </div>
        </div>

        <!-- Page 5: Result -->
        <div id="page-result" class="page">
            <div class="card">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">AI 최종 판단 결과</h2>
                
                <div class="mb-6 p-4 bg-gray-50 rounded-lg border">
                    <h3 class="font-bold text-lg text-gray-700 mb-2">A님의 이야기</h3>
                    <p id="result-story-a" class="text-gray-600 whitespace-pre-wrap"></p>
                </div>

                <div class="mb-8 p-4 bg-gray-50 rounded-lg border">
                    <h3 class="font-bold text-lg text-gray-700 mb-2">B님의 이야기</h3>
                    <p id="result-story-b" class="text-gray-600 whitespace-pre-wrap"></p>
                </div>

                <div id="ai-judgment" class="p-6 bg-blue-50 border-l-4 border-blue-500 rounded-r-lg">
                    <!-- AI Judgment will be inserted here -->
                </div>
                <button id="start-over-2" class="btn btn-secondary mt-8 w-full">새로운 분쟁 해결하기</button>
            </div>
        </div>

        <!-- Message Box -->
        <div id="message-box" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg" style="display: none;"></div>
        <div id="error-box" class="fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg" style="display: none;"></div>

    </div>

    <script>
        // --- DOM Elements ---
        const pages = document.querySelectorAll('.page');
        const storyAInput = document.getElementById('story-a');
        const submitAButton = document.getElementById('submit-a');
        const linkForBInput = document.getElementById('link-for-b');
        const copyLinkButton = document.getElementById('copy-link');
        const storyADisplay = document.getElementById('story-a-display');
        const storyBInput = document.getElementById('story-b');
        const submitBButton = document.getElementById('submit-b');
        const resultStoryA = document.getElementById('result-story-a');
        const resultStoryB = document.getElementById('result-story-b');
        const aiJudgmentContainer = document.getElementById('ai-judgment');
        const messageBox = document.getElementById('message-box');
        const errorBox = document.getElementById('error-box');
        const startOverButtons = [document.getElementById('start-over-1'), document.getElementById('start-over-2')];

        // --- Utility Functions ---
        function showPage(pageId) {
            pages.forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }

        function showMessage(text, isError = false, duration = 4000) {
            const box = isError ? errorBox : messageBox;
            box.textContent = text;
            box.style.display = 'block';
            setTimeout(() => {
                box.style.display = 'none';
            }, duration);
        }

        // --- Core Logic ---
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const storyA = params.get('a');

            if (storyA) {
                // This is B's view
                try {
                    const decodedStoryA = decodeURIComponent(atob(storyA));
                    storyADisplay.textContent = decodedStoryA;
                    showPage('page-b-input');
                } catch (e) {
                    console.error("Failed to decode story A:", e);
                    showMessage("잘못된 링크입니다. 처음부터 다시 시작해주세요.", true);
                    window.history.replaceState({}, '', window.location.pathname);
                    showPage('page-a-input');
                }
            } else {
                // This is A's view (or starting fresh)
                showPage('page-a-input');
            }
        };

        submitAButton.addEventListener('click', () => {
            const storyA = storyAInput.value.trim();
            if (!storyA) {
                showMessage("A님의 이야기를 입력해주세요.", true);
                return;
            }
            const encodedStoryA = btoa(encodeURIComponent(storyA));
            const link = `${window.location.origin}${window.location.pathname}?a=${encodedStoryA}`;
            linkForBInput.value = link;
            showPage('page-a-link');
        });

        copyLinkButton.addEventListener('click', () => {
            linkForBInput.select();
            try {
                // Using document.execCommand for broader compatibility in iFrames
                document.execCommand('copy');
                showMessage("링크가 복사되었습니다!");
            } catch (err) {
                showMessage("복사에 실패했습니다. 직접 복사해주세요.", true);
            }
        });

        submitBButton.addEventListener('click', () => {
            const storyB = storyBInput.value.trim();
            if (!storyB) {
                showMessage("B님의 이야기를 입력해주세요.", true);
                return;
            }
            const params = new URLSearchParams(window.location.search);
            const storyAEncoded = params.get('a');
            const storyA = decodeURIComponent(atob(storyAEncoded));

            getAiJudgment(storyA, storyB);
        });
        
        startOverButtons.forEach(button => {
            button.addEventListener('click', () => {
                window.location.href = window.location.pathname;
            });
        });

        /**
         * Converts a simple markdown-like text to HTML.
         * @param {string} text - The text to convert.
         * @returns {string} - The converted HTML string.
         */
        function markdownToHtml(text) {
            // Replace bold syntax first to avoid conflicts
            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-gray-800">$1</strong>');
            
            const lines = html.split('\n').filter(line => line.trim() !== '');
            html = '';
            let inList = false;

            for (const line of lines) {
                const trimmedLine = line.trim();
                
                if (trimmedLine.startsWith('###')) {
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<h3 class="text-xl font-bold text-blue-800 mb-4 mt-6">${trimmedLine.replace(/###\s*/, '')}</h3>`;
                } else if (trimmedLine.startsWith('* ')) {
                    if (!inList) {
                        html += '<ul class="list-disc list-inside space-y-2 mt-2 text-gray-700">';
                        inList = true;
                    }
                    html += `<li>${trimmedLine.substring(2)}</li>`;
                } else {
                    if (inList) { html += '</ul>'; inList = false; }
                    // Avoid wrapping h3 content in p tags
                    if (!trimmedLine.startsWith('<h3')) {
                         html += `<p class="text-gray-600 mt-2 leading-relaxed">${trimmedLine}</p>`;
                    } else {
                         html += trimmedLine;
                    }
                }
            }

            if (inList) { html += '</ul>'; }
            return html;
        }


        // --- AI Judgment Function (REVISED & IMPROVED) ---
        async function getAiJudgment(storyA, storyB) {
            showPage('page-loading');
            
            // The API key provided by the user.
            const apiKey = "AIzaSyAsGXTqp5L0pTc-FFWV63yJ-ofKV8Xm_Gw"; 
            // Changed model to gemini-2.5-pro as requested
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${apiKey}`;

            const prompt = `당신은 매우 공정하고 객관적인 AI 심판입니다. 당신의 임무는 A와 B 사이의 다음 분쟁을 분석하는 것입니다. 당신의 판단은 편파적이지 않고, 일반적인 사회 통념, 상식, 그리고 법적, 도덕적 원칙에 근거해야 합니다.

오직 제공된 정보에만 입각하여, 이 상황에 대해 누가 더 큰 책임이 있는지 비율(예: A: 60%, B: 40%)로 명확히 제시하고 그 이유를 논리적으로 설명해 주십시오. 언급되지 않은 모든 사항은 그것을 생략한 사람의 책임으로 간주합니다.

또한, 보통 사람이 이런 상황을 어떻게 인식하고 반응하는 것이 현명한지에 대한 조언도 함께 제공해 주십시오.

답변은 반드시 다음 형식에 맞춰 한국어로 작성해주세요:

### AI 최종 분석

**1. 책임 소재 분석 (누구의 잘못이 더 큰가요?)**
* **A의 책임**: [책임 비율]%
* **B의 책임**: [책임 비율]%
* **판단 근거**: [여기에 A와 B의 책임 비율을 산정한 구체적이고 논리적인 이유를 설명합니다. 각 주장의 타당성을 분석하고, 행동의 결과를 평가합니다.]

**2. 일반적인 관점 및 현명한 대처 방안**
[이러한 갈등 상황에서 일반적인 사람들이 어떻게 생각하고 행동하는지, 그리고 이 상황을 더 긍정적으로 해결하기 위한 건설적인 조언을 제공합니다.]

---

### 분쟁 내용

**A의 이야기:**
${storyA}

**B의 이야기:**
${storyB}
`;

            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    temperature: 0.5,
                    topK: 1,
                    topP: 1,
                    maxOutputTokens: 2048,
                }
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (!response.ok) {
                    console.error("API Error Body:", result);
                    const errorMessage = result?.error?.message || `API 요청 실패: ${response.status}`;
                    throw new Error(errorMessage);
                }
                
                // --- Robust API Response Handling ---
                const candidate = result.candidates?.[0];
                if (!candidate) {
                    throw new Error("AI로부터 유효한 응답을 받지 못했습니다. (응답 후보 없음)");
                }

                if (candidate.finishReason && candidate.finishReason !== 'STOP') {
                    let reasonText = `AI가 응답 생성을 중단했습니다. (사유: ${candidate.finishReason})`;
                     if(candidate.finishReason === 'SAFETY'){
                        reasonText = "AI가 안전상의 이유로 답변을 생성할 수 없습니다. 내용을 수정하여 다시 시도해주세요.";
                     }
                    throw new Error(reasonText);
                }

                const judgmentText = candidate.content?.parts?.[0]?.text;
                if (!judgmentText) {
                    throw new Error("AI 응답 내용이 비어있습니다.");
                }
                
                // --- Display results ---
                resultStoryA.textContent = storyA;
                resultStoryB.textContent = storyB;
                
                aiJudgmentContainer.innerHTML = markdownToHtml(judgmentText);

                showPage('page-result');

            } catch (error) {
                console.error("AI 판단 요청 중 오류 발생:", error);
                
                showMessage(`AI 분석 중 오류가 발생했습니다: ${error.message}`, true, 6000);
                showPage('page-b-input'); // Go back to B's input page on error
            }
        }
    </script>
</body>
</html>
