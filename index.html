<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 분쟁 해결사</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas library for saving results as an image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8fafc;
        }
        .page { display: none; }
        .page.active { display: block; }
        .card {
            background-color: white;
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .btn {
            display: inline-block;
            font-weight: 700;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            user-select: none;
            background-color: #3b82f6;
            color: white;
            padding: 0.875rem 1.75rem;
            border-radius: 0.75rem;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-secondary { background-color: #6b7280; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-tertiary { background-color: #10b981; }
        .btn-tertiary:hover { background-color: #059669; }
        textarea { resize: vertical; }
        #loading-spinner div { border-color: #3b82f6 transparent transparent transparent; }
        .name-input {
            border: none;
            background-color: #e0e7ff;
            color: #3730a3;
            font-weight: bold;
            font-size: 1.5rem;
            line-height: 2rem;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            width: auto;
            max-width: 150px;
            text-align: center;
            transition: all 0.2s ease;
        }
        .name-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .name-input:disabled {
             background-color: #e5e7eb;
             color: #4b5563;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto">
        <!-- Header -->
        <header id="main-header" class="text-center mb-8">
            <h1 class="text-5xl font-bold text-gray-800">AI 분쟁 해결사</h1>
            <p class="text-gray-500 mt-3 text-lg">AI가 당신의 갈등 상황을 객관적으로 분석해 드립니다.</p>
        </header>

        <!-- Page 1: A's Input -->
        <div id="page-a-input" class="page active">
            <div class="card space-y-6">
                <div class="p-4 bg-slate-50 rounded-lg">
                     <div class="flex items-center space-x-2">
                         <input id="name-me-input-a" class="name-input" value="나">
                         <span class="text-2xl font-bold text-gray-600">의 의견</span>
                     </div>
                </div>
                <div class="p-4 bg-slate-50 rounded-lg">
                    <label for="name-opponent-input-a" class="text-gray-600 mb-2 block font-semibold">상대방의 이름을 정해주세요.</label>
                    <input id="name-opponent-input-a" class="name-input text-lg w-full" value="상대">
                </div>
                <textarea id="story-a" class="w-full p-4 border border-gray-300 rounded-lg h-48 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-slate-50" placeholder="여기에 상황을 입력하세요..."></textarea>
                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <label class="flex items-center">
                        <input type="checkbox" id="agree-a" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="ml-3 text-sm text-gray-700">AI 분석 결과, 제가 더 잘못한 것으로 나올 경우 상대방에게 진심어린 사과를 할 것을 약속합니다.</span>
                    </label>
                </div>
                <button id="submit-a" class="btn mt-2 w-full" disabled>상대방에게 보낼 링크 생성하기</button>
            </div>
        </div>

        <!-- Page 2: Link for B -->
        <div id="page-a-link" class="page">
            <div class="card text-center">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">링크 생성 완료!</h2>
                <p class="text-gray-600 mb-6">아래 링크를 복사하여 상대방에게 전달해주세요. 상대방이 입장을 작성하면 AI 분석 결과를 확인할 수 있습니다.</p>
                <input id="link-for-b" type="text" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-center" readonly>
                <div class="mt-6 space-x-4">
                    <button id="copy-link" class="btn">링크 복사</button>
                    <button id="start-over-1" class="btn btn-secondary">처음부터 다시하기</button>
                </div>
                 <p class="text-xs text-gray-400 mt-6">이 링크는 24시간 동안 유효합니다.</p>
            </div>
        </div>

        <!-- Page 3: B's Input -->
        <div id="page-b-input" class="page">
            <div class="card space-y-6">
                 <div class="p-4 bg-slate-50 rounded-lg">
                         <div class="flex items-center space-x-2">
                             <input id="name-me-input-b" class="name-input" value="나">
                             <span class="text-2xl font-bold text-gray-600">의 의견</span>
                         </div>
                 </div>
                <div class="p-4 bg-slate-50 rounded-lg">
                    <h3 class="font-bold text-lg text-gray-700 mb-2"><span id="name-opponent-display-b">상대</span>의 의견</h3>
                    <div id="story-a-display" class="w-full p-3 border border-gray-200 bg-white rounded-lg h-32 overflow-y-auto text-sm"></div>
                </div>
                <textarea id="story-b" class="w-full p-4 border border-gray-300 rounded-lg h-48 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-slate-50" placeholder="여기에 당신의 입장을 입력하세요..."></textarea>
                 <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <label class="flex items-center">
                        <input type="checkbox" id="agree-b" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="ml-3 text-sm text-gray-700">AI 분석 결과, 제가 더 잘못한 것으로 나올 경우 상대방에게 진심어린 사과를 할 것을 약속합니다.</span>
                    </label>
                </div>
                <button id="submit-b" class="btn mt-2 w-full" disabled>AI에게 최종 판단 요청하기</button>
            </div>
        </div>

        <!-- Page 4: Loading -->
        <div id="page-loading" class="page">
            <div class="card text-center">
                <div class="flex justify-center items-center mb-6">
                    <div id="loading-spinner" class="w-16 h-16 border-4 border-t-4 rounded-full animate-spin"></div>
                </div>
                <h2 class="text-2xl font-bold text-gray-700">AI가 분석 중입니다...</h2>
                <p class="text-gray-600 mt-2">두 분의 입장을 종합하여 객관적인 판단을 내리고 있습니다. 잠시만 기다려주세요.</p>
            </div>
        </div>

        <!-- Page 5: Result -->
        <div id="page-result" class="page">
            <div id="result-card-content" class="card">
                <div id="result-title-container" class="text-center mb-8"></div>
                <div id="ai-judgment"></div>
                <div id="result-buttons" class="mt-8 w-full space-y-4 md:space-y-0 md:flex md:flex-wrap md:gap-4">
                    <button id="save-result-as-image" class="btn w-full md:flex-1">결과 이미지로 저장</button>
                    <button id="share-result-link" class="btn btn-tertiary w-full md:flex-1">결과 링크 공유</button>
                    <button id="start-over-2" class="btn btn-secondary w-full mt-4 md:mt-0 md:w-full">새로운 분쟁 해결하기</button>
                </div>
            </div>
        </div>

        <!-- Message Box -->
        <div id="message-box" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg" style="display: none;"></div>
        <div id="error-box" class="fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg" style="display: none;"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDoc, updateDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Elements ---
        const pages = document.querySelectorAll('.page');
        const storyAInput = document.getElementById('story-a');
        const submitAButton = document.getElementById('submit-a');
        const linkForBInput = document.getElementById('link-for-b');
        const copyLinkButton = document.getElementById('copy-link');
        const storyADisplay = document.getElementById('story-a-display');
        const storyBInput = document.getElementById('story-b');
        const submitBButton = document.getElementById('submit-b');
        const aiJudgmentContainer = document.getElementById('ai-judgment');
        const messageBox = document.getElementById('message-box');
        const errorBox = document.getElementById('error-box');
        const startOverButtons = [document.getElementById('start-over-1'), document.getElementById('start-over-2')];
        const saveResultAsImageButton = document.getElementById('save-result-as-image');
        const shareResultLinkButton = document.getElementById('share-result-link');
        const nameMeInputA = document.getElementById('name-me-input-a');
        const nameOpponentInputA = document.getElementById('name-opponent-input-a');
        const nameMeInputB = document.getElementById('name-me-input-b');
        const nameOpponentDisplayB = document.getElementById('name-opponent-display-b');
        const agreeA = document.getElementById('agree-a');
        const agreeB = document.getElementById('agree-b');
        const resultTitleContainer = document.getElementById('result-title-container');
        const resultCardContent = document.getElementById('result-card-content');

        // --- Global State ---
        let disputeId = null;
        let db, auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ai-judge-21e60';

        // --- Utility Functions ---
        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        function showMessage(text, isError = false, duration = 4000) {
            const box = isError ? errorBox : messageBox;
            box.textContent = text;
            box.style.display = 'block';
            setTimeout(() => { box.style.display = 'none'; }, duration);
        }
        
        function copyToClipboard(text, successMessage) {
            const tempInput = document.createElement('input');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                document.execCommand('copy');
                showMessage(successMessage);
            } catch (err) {
                showMessage("복사에 실패했습니다. 직접 복사해주세요.", true);
            }
            document.body.removeChild(tempInput);
        }

        // --- Core Logic ---
        async function initialize() {
            try {
                // Use the provided firebase config if available, otherwise use the hardcoded one.
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                    apiKey: "AIzaSyCBa_jQmxyQHBQ57YFptbv9bai9enb6jh8", // Fallback API Key updated
                    authDomain: "ai-judge-21e60.firebaseapp.com",
                    projectId: "ai-judge-21e60",
                    storageBucket: "ai-judge-21e60.appspot.com",
                    messagingSenderId: "685131448318",
                    appId: "1:685131448318:web:aab1773aed2df0011ccaaf"
                };
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                // Sign in the user
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("서비스를 시작할 수 없습니다. 나중에 다시 시도해주세요.", true);
                return;
            }

            const params = new URLSearchParams(window.location.search);
            disputeId = params.get('disputeId');

            if (disputeId) {
                await loadDispute(disputeId);
            } else {
                showPage('page-a-input');
            }
        }

        async function loadDispute(id) {
            showPage('page-loading');
            try {
                const docRef = doc(db, "artifacts", appId, "public/data/disputes", id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    if (data.status === 'resolved') {
                        aiJudgmentContainer.innerHTML = createResultHtmlFromJson(data);
                        resultTitleContainer.innerHTML = createResultTitle(data.judgment, data.nameA, data.nameB);
                        showPage('page-result');
                    } else if (data.status === 'pending_b') {
                        nameMeInputB.value = data.nameB;
                        nameOpponentDisplayB.textContent = data.nameA;
                        storyADisplay.textContent = data.storyA;
                        showPage('page-b-input');
                    } else {
                         showMessage("이미 분석이 진행중이거나 완료된 분쟁입니다.", false);
                         // Potentially show a waiting page or the result if available
                         if(data.judgment) {
                            aiJudgmentContainer.innerHTML = createResultHtmlFromJson(data);
                            resultTitleContainer.innerHTML = createResultTitle(data.judgment, data.nameA, data.nameB);
                            showPage('page-result');
                         } else {
                            showPage('page-a-input');
                         }
                    }
                } else {
                    showMessage("해당 분쟁을 찾을 수 없습니다. 링크가 올바른지 확인해주세요.", true);
                    window.history.replaceState({}, '', window.location.pathname);
                    showPage('page-a-input');
                }
            } catch (error) {
                console.error("Dispute loading failed:", error);
                showMessage("분쟁 정보를 불러오는 데 실패했습니다.", true);
                showPage('page-a-input');
            }
        }

        window.onload = initialize;

        // --- Event Listeners ---
        agreeA.addEventListener('change', () => { submitAButton.disabled = !agreeA.checked; });
        agreeB.addEventListener('change', () => { submitBButton.disabled = !agreeB.checked; });

        submitAButton.addEventListener('click', async () => {
            const nameA = nameMeInputA.value.trim();
            const nameB = nameOpponentInputA.value.trim();
            const storyA = storyAInput.value.trim();

            if (!storyA || !nameA || !nameB) {
                showMessage("이름과 이야기를 모두 입력해주세요.", true); return;
            }
            if (nameA === nameB) {
                showMessage("서로 다른 이름을 입력해주세요.", true); return;
            }

            submitAButton.disabled = true;
            submitAButton.textContent = "생성 중...";

            try {
                const disputesCollection = collection(db, "artifacts", appId, "public/data/disputes");
                const docRef = await addDoc(disputesCollection, {
                    nameA,
                    nameB,
                    storyA,
                    status: 'pending_b',
                    createdAt: serverTimestamp()
                });
                
                disputeId = docRef.id;
                const link = `${window.location.origin}${window.location.pathname}?disputeId=${disputeId}`;
                linkForBInput.value = link;
                showPage('page-a-link');

            } catch (error) {
                console.error("Dispute creation failed:", error);
                showMessage("링크 생성에 실패했습니다. 다시 시도해주세요.", true);
            } finally {
                submitAButton.disabled = false;
                submitAButton.textContent = "상대방에게 보낼 링크 생성하기";
            }
        });

        submitBButton.addEventListener('click', async () => {
            const storyB = storyBInput.value.trim();
            const updatedNameB = nameMeInputB.value.trim();
            
            if (!storyB) {
                showMessage("당신의 이야기를 입력해주세요.", true); return;
            }
            
            try {
                const docRef = doc(db, "artifacts", appId, "public/data/disputes", disputeId);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) throw new Error("Dispute not found");

                const originalData = docSnap.data();

                await updateDoc(docRef, {
                    nameB: updatedNameB,
                    storyB: storyB,
                    status: 'pending_analysis'
                });

                getAiJudgment(originalData.storyA, storyB, originalData.nameA, updatedNameB);

            } catch (error) {
                console.error("Dispute submission failed:", error);
                showMessage("정보 제출에 실패했습니다. 다시 시도해주세요.", true);
            }
        });

        startOverButtons.forEach(button => {
            button.addEventListener('click', () => { window.location.href = window.location.pathname; });
        });

        saveResultAsImageButton.addEventListener('click', () => {
            showMessage("이미지 생성 중입니다. 잠시만 기다려주세요...");
            const buttons = resultCardContent.querySelector('#result-buttons');
            buttons.style.display = 'none';

            html2canvas(resultCardContent, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'AI_분쟁_해결_결과.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                buttons.style.display = 'flex'; // Use flex for consistency with the layout
                showMessage("이미지가 저장되었습니다!");
            }).catch(err => {
                console.error("Image generation failed:", err);
                showMessage("이미지 저장에 실패했습니다.", true);
                buttons.style.display = 'flex';
            });
        });
        
        shareResultLinkButton.addEventListener('click', () => {
            const link = `${window.location.origin}${window.location.pathname}?disputeId=${disputeId}`;
            copyToClipboard(link, "결과 링크가 복사되었습니다!");
        });

        copyLinkButton.addEventListener('click', () => {
            copyToClipboard(linkForBInput.value, "링크가 복사되었습니다!");
        });

        // --- Result Page UI Generation ---
        function createResultTitle(data, nameA, nameB) {
            const { responsibilityA, responsibilityB } = data;
            let winner, loser, titleHtml;
            
            // Determine who has more responsibility. The one with more is the 'winner' in the context of being assigned more blame.
            if (responsibilityA > responsibilityB) {
                winner = nameA; loser = nameB;
                titleHtml = `<h2 class="text-3xl font-bold text-gray-800">AI 분석 결과, 본 분쟁의 주된 책임은 <span class="text-blue-600">${winner}</span>님에게 있습니다.</h2><p class="text-gray-600 mt-2"><span class="font-bold">${loser}</span>님에게 정중히 사과하고, 갈등 해결을 위해 노력하는 것을 권고합니다.</p>`;
            } else if (responsibilityB > responsibilityA) {
                winner = nameB; loser = nameA;
                // Note: The original code had red for B, which might be confusing. Let's stick to a consistent color for the person with more responsibility.
                titleHtml = `<h2 class="text-3xl font-bold text-gray-800">AI 분석 결과, 본 분쟁의 주된 책임은 <span class="text-blue-600">${winner}</span>님에게 있습니다.</h2><p class="text-gray-600 mt-2"><span class="font-bold">${loser}</span>님에게 정중히 사과하고, 갈등 해결을 위해 노력하는 것을 권고합니다.</p>`;
            } else {
                 titleHtml = `<h2 class="text-3xl font-bold text-gray-800">본 분쟁은 <span class="text-green-600">양측 모두에게 동등한 책임</span>이 있는 것으로 판단됩니다.</h2><p class="text-gray-600 mt-2">서로의 입장을 이해하고 원만하게 대화로 해결하시기를 바랍니다.</p>`;
            }
            return titleHtml;
        }

        function createResultHtmlFromJson(disputeData) {
            const { judgment, nameA, nameB, storyA, storyB } = disputeData;
            const { responsibilityA, responsibilityB, case_summary, main_issue, analysis_A, analysis_B, conclusion } = judgment;

            const originalOpinionsHtml = `
                <div class="p-5 bg-white rounded-xl border shadow-sm">
                    <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
                        ${nameA}님의 최초 의견
                    </h4>
                    <div class="text-gray-600 leading-relaxed space-y-2 text-sm bg-blue-50 p-3 rounded-md">${storyA.replace(/\n/g, '<br>')}</div>
                </div>
                <div class="p-5 bg-white rounded-xl border shadow-sm">
                    <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
                        ${nameB}님의 최초 의견
                    </h4>
                    <div class="text-gray-600 leading-relaxed space-y-2 text-sm bg-red-50 p-3 rounded-md">${storyB.replace(/\n/g, '<br>')}</div>
                </div>
            `;

            const analysisCards = [
                { title: '사건 개요', content: case_summary, icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>` },
                { title: '핵심 쟁점', content: main_issue, icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H5v-2H3v-2H1v-4a6 6 0 017.743-5.743L13 5h2v2h2v2z" /></svg>` },
                { title: `${nameA}측 분석`, content: analysis_A, icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>` },
                { title: `${nameB}측 분석`, content: analysis_B, icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>` },
                { title: '최종 결론', content: conclusion, icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>` }
            ];

            const responsibilityBarHtml = `<div><div class="flex items-center justify-between mb-2 text-base font-bold"><span class="text-blue-600">${nameA} 책임</span><span class="text-red-600">${nameB} 책임</span></div><div class="w-full bg-gray-200 rounded-full h-8 flex overflow-hidden border-2 border-white shadow-inner"><div class="bg-blue-500 h-full flex items-center justify-center text-white font-bold text-sm" style="width: ${responsibilityA}%; line-height: 2rem;">${responsibilityA > 0 ? responsibilityA + '%' : ''}</div><div class="bg-red-500 h-full flex items-center justify-center text-white font-bold text-sm" style="width: ${responsibilityB}%; line-height: 2rem;">${responsibilityB > 0 ? responsibilityB + '%' : ''}</div></div></div>`;
            
            const analysisCardsHtml = analysisCards.map(card => `<div class="p-5 bg-white rounded-xl border shadow-sm"><h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center">${card.icon}${card.title}</h4><div class="text-gray-600 leading-relaxed space-y-2 text-sm">${card.content.replace(/\n/g, '<br>')}</div></div>`).join('');

            return `<div class="space-y-6 bg-slate-100 p-6 rounded-2xl border border-slate-200">${responsibilityBarHtml}${originalOpinionsHtml}${analysisCardsHtml}</div>`;
        }

        // --- AI API Call ---
        async function getAiJudgment(storyA, storyB, nameA, nameB) {
            showPage('page-loading');
            
            // Apply the user-provided Gemini API key and model.
            const apiKey = "AIzaSyDHiqgZsHKQAw8ce7N3nuRcdpWqnYKgIpY"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${apiKey}`;

            const prompt = `
너는 공감 능력이 뛰어나고 현명한 'AI 분쟁 해결사'이다. 당신의 임무는 ${nameA}와 ${nameB} 사이의 갈등을 객관적인 사실에 근거하여 분석하되, 누구나 쉽게 이해할 수 있도록 친절하고 부드러운 말투로 설명하는 것이다.
법률 용어나 어려운 단어 사용은 최소화하고, 양측의 입장을 모두 고려하여 중립적인 시각을 유지해야 한다.
특히, 각 분석 항목에서 "보통 이런 상황에서는..." 또는 "일반적으로 사람들은..." 과 같이, 평범한 사람들이 비슷한 상황에서 어떻게 느끼고 행동하는지에 대한 예시를 들어 설명해주면 좋다. 이를 통해 당사자들이 자신의 행동을 객관적으로 돌아볼 수 있도록 도와야 한다.
책임 비율(responsibilityA, responsibilityB)은 반드시 합쳐서 100이 되도록 정밀하게 산정해야 한다.
답변은 반드시 다음 JSON 형식에 맞춰서, 다른 설명 없이 JSON 객체만 반환해야 한다.
모든 텍스트는 친절하고 이해하기 쉬운 존댓말로 작성하며, ${nameA}와 ${nameB}라는 이름을 사용해야 한다.

{
  "responsibilityA": 0,
  "responsibilityB": 0,
  "case_summary": "양측의 주장에서 사실로 확인 가능한 정보만을 추출하여 사건을 재구성합니다.",
  "main_issue": "이 분쟁의 법적, 논리적 핵심 쟁점이 무엇인지 정의합니다.",
  "analysis_A": "${nameA}의 행동과 주장을 분쟁의 원인, 과정, 결과에 미친 영향을 중심으로 논리적으로 분석합니다. 귀책 사유가 될 수 있는 부분을 명시합니다.",
  "analysis_B": "${nameB}의 행동과 주장을 분쟁의 원인, 과정, 결과에 미친 영향을 중심으로 논리적으로 분석합니다. 귀책 사유가 될 수 있는 부분을 명시합니다.",
  "conclusion": "위 분석을 종합하여, 각자의 책임 소재와 비율을 명시하고, 갈등의 평화로운 해결을 위한 구체적이고 실행 가능한 권고안을 제시합니다."
}

---
### 분쟁 내용
**${nameA}의 의견:**
${storyA}

**${nameB}의 의견:**
${storyB}
`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { 
                    responseMimeType: "application/json",
                }
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorResult = await response.json();
                    console.error("API Error Body:", errorResult);
                    const errorMessage = errorResult?.error?.message || `API 요청 실패: ${response.status}`;
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                    throw new Error("AI로부터 유효한 응답을 받지 못했습니다.");
                }

                const judgmentJsonText = candidate.content.parts[0].text;
                const judgmentData = JSON.parse(judgmentJsonText);
                
                // Save result to Firestore
                const docRef = doc(db, "artifacts", appId, "public/data/disputes", disputeId);
                await updateDoc(docRef, {
                    judgment: judgmentData,
                    status: 'resolved'
                });

                const disputeDataForRender = {
                    judgment: judgmentData,
                    nameA: nameA,
                    nameB: nameB,
                    storyA: storyA,
                    storyB: storyB
                };
                aiJudgmentContainer.innerHTML = createResultHtmlFromJson(disputeDataForRender);
                resultTitleContainer.innerHTML = createResultTitle(judgmentData, nameA, nameB);

                showPage('page-result');

            } catch (error) {
                console.error("AI judgment request error:", error);
                showMessage(`AI 분석 중 오류가 발생했습니다: ${error.message}`, true, 6000);
                // Go back to B's input page on failure
                showPage('page-b-input'); 
            }
        }
    </script>
</body>
</html>
