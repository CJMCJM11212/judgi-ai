<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 분쟁 해결사</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8fafc; /* Lighter gray background */
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .card {
            background-color: white;
            border-radius: 1.5rem; /* More rounded corners */
            padding: 2.5rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .btn {
            display: inline-block;
            font-weight: 700; /* Bolder font */
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            user-select: none;
            background-color: #3b82f6;
            color: white;
            padding: 0.875rem 1.75rem;
            border-radius: 0.75rem;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-secondary {
            background-color: #6b7280;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        textarea {
            resize: vertical;
        }
        #loading-spinner div {
            border-color: #3b82f6 transparent transparent transparent;
        }
        .name-input {
            border: none;
            background: transparent;
            font-weight: bold;
            font-size: 1.5rem;
            line-height: 2rem;
            color: #1f2937;
            width: auto;
            max-width: 150px;
        }
        .name-input:focus {
            outline: none;
            border-bottom: 2px solid #3b82f6;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto">
        <!-- Header -->
        <header id="main-header" class="text-center mb-8">
            <h1 class="text-5xl font-bold text-gray-800">AI 분쟁 해결사</h1>
            <p class="text-gray-500 mt-3 text-lg">AI가 당신의 갈등 상황을 객관적으로 분석해 드립니다.</p>
        </header>

        <!-- Page 1: A's Input -->
        <div id="page-a-input" class="page active">
            <div class="card space-y-6">
                <div class="p-4 bg-slate-50 rounded-lg">
                     <div class="flex items-center">
                        <input id="name-me-input-a" class="name-input" value="나" disabled>
                        <span class="text-2xl font-bold text-gray-600">의 의견</span>
                        <button id="edit-name-me-a" class="ml-2 p-1 text-gray-400 hover:text-blue-500">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="p-4 bg-slate-50 rounded-lg">
                    <label for="name-opponent-input-a" class="text-gray-600 mb-2 block font-semibold">상대방의 이름을 정해주세요.</label>
                    <input id="name-opponent-input-a" class="name-input text-lg w-full" value="상대">
                </div>
                <textarea id="story-a" class="w-full p-4 border border-gray-300 rounded-lg h-48 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-slate-50" placeholder="여기에 상황을 입력하세요..."></textarea>
                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <label class="flex items-center">
                        <input type="checkbox" id="agree-a" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="ml-3 text-sm text-gray-700">AI 분석 결과, 제가 더 잘못한 것으로 나올 경우 상대방에게 진심어린 사과를 할 것을 약속합니다.</span>
                    </label>
                </div>
                <button id="submit-a" class="btn mt-2 w-full" disabled>상대방에게 보낼 링크 생성하기</button>
            </div>
        </div>

        <!-- Page 2: Link for B -->
        <div id="page-a-link" class="page">
            <div class="card text-center">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">링크 생성 완료!</h2>
                <p class="text-gray-600 mb-6">아래 링크를 복사하여 상대방에게 전달해주세요. 상대방이 입장을 작성하면 AI 분석 결과를 확인할 수 있습니다.</p>
                <input id="link-for-b" type="text" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-center" readonly>
                <div class="mt-6 space-x-4">
                    <button id="copy-link" class="btn">링크 복사</button>
                    <button id="start-over-1" class="btn btn-secondary">처음부터 다시하기</button>
                </div>
            </div>
        </div>

        <!-- Page 3: B's Input -->
        <div id="page-b-input" class="page">
            <div class="card space-y-6">
                 <div class="p-4 bg-slate-50 rounded-lg">
                     <div class="flex items-center">
                        <input id="name-me-input-b" class="name-input" value="나" disabled>
                        <span class="text-2xl font-bold text-gray-600">의 의견</span>
                        <button id="edit-name-me-b" class="ml-2 p-1 text-gray-400 hover:text-blue-500">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="p-4 bg-slate-50 rounded-lg">
                    <h3 class="font-bold text-lg text-gray-700 mb-2"><span id="name-opponent-display-b">상대</span>의 의견</h3>
                    <div id="story-a-display" class="w-full p-3 border border-gray-200 bg-white rounded-lg h-32 overflow-y-auto text-sm"></div>
                </div>
                <textarea id="story-b" class="w-full p-4 border border-gray-300 rounded-lg h-48 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-slate-50" placeholder="여기에 당신의 입장을 입력하세요..."></textarea>
                 <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <label class="flex items-center">
                        <input type="checkbox" id="agree-b" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="ml-3 text-sm text-gray-700">AI 분석 결과, 제가 더 잘못한 것으로 나올 경우 상대방에게 진심어린 사과를 할 것을 약속합니다.</span>
                    </label>
                </div>
                <button id="submit-b" class="btn mt-2 w-full" disabled>AI에게 최종 판단 요청하기</button>
            </div>
        </div>

        <!-- Page 4: Loading -->
        <div id="page-loading" class="page">
            <div class="card text-center">
                <div class="flex justify-center items-center mb-6">
                    <div id="loading-spinner" class="w-16 h-16 border-4 border-t-4 rounded-full animate-spin"></div>
                </div>
                <h2 class="text-2xl font-bold text-gray-700">AI가 분석 중입니다...</h2>
                <p class="text-gray-600 mt-2">두 분의 입장을 종합하여 객관적인 판단을 내리고 있습니다. 잠시만 기다려주세요.</p>
            </div>
        </div>

        <!-- Page 5: Result -->
        <div id="page-result" class="page">
            <div class="card">
                <div id="result-title-container" class="text-center mb-8"></div>
                <div id="ai-judgment"></div>
                <div id="result-buttons" class="mt-8 w-full space-y-4 md:space-y-0 md:space-x-4 md:flex">
                    <button id="share-result" class="btn w-full md:w-1/2">결과 공유하기</button>
                    <button id="start-over-2" class="btn btn-secondary w-full md:w-1/2">새로운 분쟁 해결하기</button>
                </div>
            </div>
        </div>
        
        <!-- Page 6: Share Link -->
        <div id="page-share-link" class="page">
            <div class="card text-center">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">결과 공유 링크</h2>
                <p class="text-gray-600 mb-6">아래 링크를 복사하여 다른 사람에게 공유하면, 현재 AI 분석 결과를 바로 확인할 수 있습니다.</p>
                <input id="share-link-input" type="text" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-center" readonly>
                <div class="mt-6 space-x-4">
                    <button id="copy-share-link" class="btn">링크 복사</button>
                    <button id="back-to-result" class="btn btn-secondary">결과로 돌아가기</button>
                </div>
            </div>
        </div>


        <!-- Message Box -->
        <div id="message-box" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg" style="display: none;"></div>
        <div id="error-box" class="fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg" style="display: none;"></div>

    </div>

    <script>
        // --- DOM Elements ---
        const pages = document.querySelectorAll('.page');
        const storyAInput = document.getElementById('story-a');
        const submitAButton = document.getElementById('submit-a');
        const linkForBInput = document.getElementById('link-for-b');
        const copyLinkButton = document.getElementById('copy-link');
        const storyADisplay = document.getElementById('story-a-display');
        const storyBInput = document.getElementById('story-b');
        const submitBButton = document.getElementById('submit-b');
        const aiJudgmentContainer = document.getElementById('ai-judgment');
        const messageBox = document.getElementById('message-box');
        const errorBox = document.getElementById('error-box');
        const startOverButtons = [document.getElementById('start-over-1'), document.getElementById('start-over-2')];
        const shareResultButton = document.getElementById('share-result');
        const shareLinkInput = document.getElementById('share-link-input');
        const copyShareLinkButton = document.getElementById('copy-share-link');
        const backToResultButton = document.getElementById('back-to-result');
        const nameMeInputA = document.getElementById('name-me-input-a');
        const editNameMeA = document.getElementById('edit-name-me-a');
        const nameOpponentInputA = document.getElementById('name-opponent-input-a');
        const nameMeInputB = document.getElementById('name-me-input-b');
        const editNameMeB = document.getElementById('edit-name-me-b');
        const nameOpponentDisplayB = document.getElementById('name-opponent-display-b');
        const agreeA = document.getElementById('agree-a');
        const agreeB = document.getElementById('agree-b');
        const resultTitleContainer = document.getElementById('result-title-container');

        let state = {
            nameMe: "나",
            nameOpponent: "상대",
            storyA: "",
            storyB: "",
        };

        // --- Utility Functions ---
        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        function showMessage(text, isError = false, duration = 4000) {
            const box = isError ? errorBox : messageBox;
            box.textContent = text;
            box.style.display = 'block';
            setTimeout(() => { box.style.display = 'none'; }, duration);
        }

        // --- Core Logic ---
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const p = {
                storyA: params.get('sA'),
                storyB: params.get('sB'),
                nameMe: params.get('nM'),
                nameOpponent: params.get('nO'),
                sharedJson: params.get('sJ')
            };

            if (p.storyA && p.storyB && p.nameMe && p.nameOpponent && p.sharedJson) {
                // Shared result view
                try {
                    state.nameMe = decodeURIComponent(atob(p.nameMe));
                    state.nameOpponent = decodeURIComponent(atob(p.nameOpponent));
                    const judgmentData = JSON.parse(decodeURIComponent(atob(p.sharedJson)));
                    aiJudgmentContainer.innerHTML = createResultHtmlFromJson(judgmentData, state.nameMe, state.nameOpponent);
                    resultTitleContainer.innerHTML = createResultTitle(judgmentData, state.nameMe, state.nameOpponent);
                    document.getElementById('main-header').style.display = 'none';
                    document.getElementById('result-buttons').style.display = 'none';
                    showPage('page-result');
                } catch (e) {
                    console.error("Failed to decode shared result:", e);
                    showMessage("잘못된 공유 링크입니다.", true);
                    window.history.replaceState({}, '', window.location.pathname);
                    showPage('page-a-input');
                }
            } else if (p.storyA && p.nameMe && p.nameOpponent) {
                // B's input view
                try {
                    state.storyA = decodeURIComponent(atob(p.storyA));
                    state.nameMe = decodeURIComponent(atob(p.nameOpponent)); // B is now "me"
                    state.nameOpponent = decodeURIComponent(atob(p.nameMe)); // A is now "opponent"
                    
                    nameMeInputB.value = state.nameMe;
                    nameOpponentDisplayB.textContent = state.nameOpponent;
                    storyADisplay.textContent = state.storyA;
                    showPage('page-b-input');
                } catch (e) {
                    console.error("Failed to decode story A:", e);
                    showMessage("잘못된 링크입니다. 처음부터 다시 시작해주세요.", true);
                    window.history.replaceState({}, '', window.location.pathname);
                    showPage('page-a-input');
                }
            } else {
                showPage('page-a-input');
            }
        };

        // --- Event Listeners ---
        editNameMeA.addEventListener('click', () => {
            nameMeInputA.disabled = !nameMeInputA.disabled;
            nameMeInputA.focus();
        });

        editNameMeB.addEventListener('click', () => {
            nameMeInputB.disabled = !nameMeInputB.disabled;
            nameMeInputB.focus();
        });

        agreeA.addEventListener('change', () => {
            submitAButton.disabled = !agreeA.checked;
        });

        agreeB.addEventListener('change', () => {
            submitBButton.disabled = !agreeB.checked;
        });

        submitAButton.addEventListener('click', () => {
            state.storyA = storyAInput.value.trim();
            state.nameMe = nameMeInputA.value.trim();
            state.nameOpponent = nameOpponentInputA.value.trim();

            if (!state.storyA) {
                showMessage("당신의 이야기를 입력해주세요.", true);
                return;
            }
            if (!state.nameMe || !state.nameOpponent) {
                showMessage("이름을 모두 입력해주세요.", true);
                return;
            }

            const encoded = {
                sA: btoa(encodeURIComponent(state.storyA)),
                nM: btoa(encodeURIComponent(state.nameMe)),
                nO: btoa(encodeURIComponent(state.nameOpponent))
            };
            const link = `${window.location.origin}${window.location.pathname}?sA=${encoded.sA}&nM=${encoded.nM}&nO=${encoded.nO}`;
            linkForBInput.value = link;
            showPage('page-a-link');
        });

        submitBButton.addEventListener('click', () => {
            state.storyB = storyBInput.value.trim();
            state.nameMe = nameMeInputB.value.trim(); // Update B's name if edited
            if (!state.storyB) {
                showMessage("당신의 이야기를 입력해주세요.", true);
                return;
            }
            getAiJudgment(state.storyA, state.storyB, state.nameOpponent, state.nameMe); // A is opponent, B is me
        });
        
        startOverButtons.forEach(button => {
            button.addEventListener('click', () => { window.location.href = window.location.pathname; });
        });

        shareResultButton.addEventListener('click', () => {
            const judgmentJson = aiJudgmentContainer.dataset.rawJson;
            const encoded = {
                sA: btoa(encodeURIComponent(state.storyA)),
                sB: btoa(encodeURIComponent(state.storyB)),
                nM: btoa(encodeURIComponent(state.nameMe)),
                nO: btoa(encodeURIComponent(state.nameOpponent)),
                sJ: btoa(encodeURIComponent(judgmentJson))
            };
            const link = `${window.location.origin}${window.location.pathname}?sA=${encoded.sA}&sB=${encoded.sB}&nM=${encoded.nM}&nO=${encoded.nO}&sJ=${encoded.sJ}`;
            shareLinkInput.value = link;
            showPage('page-share-link');
        });
        
        copyLinkButton.addEventListener('click', () => {
            linkForBInput.select();
            try { document.execCommand('copy'); showMessage("링크가 복사되었습니다!"); }
            catch (err) { showMessage("복사에 실패했습니다. 직접 복사해주세요.", true); }
        });

        copyShareLinkButton.addEventListener('click', () => {
            shareLinkInput.select();
            try { document.execCommand('copy'); showMessage("공유 링크가 복사되었습니다!"); }
            catch (err) { showMessage("복사에 실패했습니다. 직접 복사해주세요.", true); }
        });

        backToResultButton.addEventListener('click', () => { showPage('page-result'); });

        // --- Result Page UI Generation ---
        function createResultTitle(data, nameA, nameB) {
            const { responsibilityA, responsibilityB } = data;
            const winner = responsibilityA > responsibilityB ? nameA : nameB;
            const loser = responsibilityA > responsibilityB ? nameB : nameA;
            if (responsibilityA === responsibilityB) {
                return `<h2 class="text-3xl font-bold text-gray-800">이번 분쟁은 <span class="text-yellow-500">두 분 모두의 잘못</span>입니다.</h2>`;
            }
            return `<h2 class="text-3xl font-bold text-gray-800">이번 분쟁은 <span class="text-red-500">${winner}의 잘못</span>입니다.</h2>
                    <p class="text-gray-600 mt-2">${loser}님께 진심으로 사과해주세요.</p>`;
        }

        function createResultHtmlFromJson(data, nameA, nameB) {
            const { responsibilityA, responsibilityB, objective, general, average, statistical, advice } = data;
            
            const analysisCards = [
                { title: '객관적 근거', content: objective, icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>` },
                { title: '일반적 근거', content: general, icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>` },
                { title: '평균적 근거', content: average, icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" /></svg>` },
                { title: '통계적 근거', content: statistical, icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>` }
            ];

            return `
                <div class="space-y-6 bg-slate-100 p-6 rounded-2xl border border-slate-200">
                    <div>
                        <div class="flex items-center justify-between mb-2 text-base font-bold">
                            <span class="text-blue-600">${nameA} 책임</span>
                            <span class="text-red-600">${nameB} 책임</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-8 flex overflow-hidden border-2 border-white shadow-inner">
                            <div class="bg-blue-500 h-full flex items-center justify-center text-white font-bold text-sm" style="width: ${responsibilityA}%">${responsibilityA}%</div>
                            <div class="bg-red-500 h-full flex items-center justify-center text-white font-bold text-sm" style="width: ${responsibilityB}%">${responsibilityB}%</div>
                        </div>
                    </div>
                    ${analysisCards.map(card => `
                    <div class="p-5 bg-white rounded-xl border shadow-sm">
                        <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center">${card.icon}${card.title}</h4>
                        <div class="text-gray-600 leading-relaxed space-y-2 text-sm">${card.content.replace(/\n/g, '<br>')}</div>
                    </div>
                    `).join('')}
                    <div class="p-5 bg-green-100 rounded-xl border border-green-200 shadow-sm">
                        <h4 class="text-lg font-bold text-green-800 mb-3 flex items-center">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            AI의 조언
                        </h4>
                        <div class="text-green-800 leading-relaxed space-y-2 text-sm">${advice.replace(/\n/g, '<br>')}</div>
                    </div>
                </div>
            `;
        }

        // --- AI API Call ---
        async function getAiJudgment(storyA, storyB, nameA, nameB) {
            showPage('page-loading');
            
            state.storyA = storyA;
            state.storyB = storyB;
            state.nameMe = nameB; // The current user is B
            state.nameOpponent = nameA;

            const apiKey = "AIzaSyAsGXTqp5L0pTc-FFWV63yJ-ofKV8Xm_Gw";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${apiKey}`;

            const prompt = `
당신은 매우 공정하고 객관적인 AI 심판입니다. 당신의 임무는 ${nameA}(이하 A)와 ${nameB}(이하 B) 사이의 분쟁을 분석하는 것입니다.
오직 제공된 정보에만 입각하여 판단하고, 답변은 반드시 다음 JSON 형식에 맞춰 한국어로 작성해주세요. 다른 설명 없이 JSON 객체만 반환해야 합니다.

{
  "responsibilityA": 0,
  "responsibilityB": 0,
  "objective": "사건의 사실 관계, 행동의 순서 등 객관적인 데이터만을 기반으로 상황을 분석해주세요.",
  "general": "이러한 상황에서 사회 구성원들이 보편적으로 어떻게 생각하고 판단하는지에 대한 일반적인 관점을 설명해주세요.",
  "average": "비슷한 갈등을 겪는 평균적인 사람들의 반응과 행동 패턴을 기반으로 상황을 분석해주세요.",
  "statistical": "만약 관련 통계나 데이터가 있다면, 이를 기반으로 한 분석을 제공해주세요. 없다면, 통계적으로 볼 때 어떤 결과가 더 흔한지 추론해주세요.",
  "advice": "분석 결과, 더 큰 잘못을 한 쪽이 어떻게 행동했어야 하는지에 대한 구체적인 조언을 해주세요."
}

---
### 분쟁 내용
**A (${nameA})의 의견:**
${storyA}

**B (${nameB})의 의견:**
${storyB}
`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { 
                    maxOutputTokens: 8192,
                    responseMimeType: "application/json",
                }
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (!response.ok) {
                    console.error("API Error Body:", result);
                    const errorMessage = result?.error?.message || `API 요청 실패: ${response.status}`;
                    throw new Error(errorMessage);
                }
                
                const candidate = result.candidates?.[0];
                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                    throw new Error("AI로부터 유효한 응답을 받지 못했습니다.");
                }

                const judgmentJsonText = candidate.content.parts[0].text;
                const judgmentData = JSON.parse(judgmentJsonText);
                
                aiJudgmentContainer.dataset.rawJson = judgmentJsonText;
                aiJudgmentContainer.innerHTML = createResultHtmlFromJson(judgmentData, nameA, nameB);
                resultTitleContainer.innerHTML = createResultTitle(judgmentData, nameA, nameB);

                showPage('page-result');

            } catch (error) {
                console.error("AI 판단 요청 중 오류 발생:", error);
                showMessage(`AI 분석 중 오류가 발생했습니다: ${error.message}`, true, 6000);
                showPage('page-b-input');
            }
        }
    </script>
</body>
</html>
