<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 분쟁 해결사</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8fafc; /* Lighter gray background */
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .card {
            background-color: white;
            border-radius: 1.5rem; /* More rounded corners */
            padding: 2.5rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .btn {
            display: inline-block;
            font-weight: 700; /* Bolder font */
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            user-select: none;
            background-color: #3b82f6;
            color: white;
            padding: 0.875rem 1.75rem;
            border-radius: 0.75rem;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-secondary {
            background-color: #6b7280;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        textarea {
            resize: vertical;
        }
        #loading-spinner div {
            border-color: #3b82f6 transparent transparent transparent;
        }
        /* --- UI 개선 사항 적용 --- */
        .name-input {
            border: none;
            background-color: #e0e7ff; /* Light blue background */
            color: #3730a3; /* Darker blue text */
            font-weight: bold;
            font-size: 1.5rem;
            line-height: 2rem;
            padding: 0.25rem 0.75rem; /* Vertical and horizontal padding */
            border-radius: 0.5rem; /* Rounded corners */
            width: auto;
            max-width: 150px;
            text-align: center;
            transition: all 0.2s ease;
        }
        .name-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* Focus ring */
        }
        .name-input:disabled {
             background-color: #e5e7eb;
             color: #4b5563;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto">
        <header id="main-header" class="text-center mb-8">
            <h1 class="text-5xl font-bold text-gray-800">AI 분쟁 해결사</h1>
            <p class="text-gray-500 mt-3 text-lg">AI가 당신의 갈등 상황을 객관적으로 분석해 드립니다.</p>
        </header>

        <div id="page-a-input" class="page active">
            <div class="card space-y-6">
                <div class="p-4 bg-slate-50 rounded-lg">
                     <div class="flex items-center space-x-2">
                        <input id="name-me-input-a" class="name-input" value="나">
                        <span class="text-2xl font-bold text-gray-600">의 의견</span>
                        <button id="edit-name-me-a" class="ml-2 p-1 text-gray-400 hover:text-blue-500 hidden">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="p-4 bg-slate-50 rounded-lg">
                    <label for="name-opponent-input-a" class="text-gray-600 mb-2 block font-semibold">상대방의 이름을 정해주세요.</label>
                    <input id="name-opponent-input-a" class="name-input text-lg w-full" value="상대">
                </div>
                <textarea id="story-a" class="w-full p-4 border border-gray-300 rounded-lg h-48 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-slate-50" placeholder="여기에 상황을 입력하세요..."></textarea>
                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <label class="flex items-center">
                        <input type="checkbox" id="agree-a" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="ml-3 text-sm text-gray-700">AI 분석 결과, 제가 더 잘못한 것으로 나올 경우 상대방에게 진심어린 사과를 할 것을 약속합니다.</span>
                    </label>
                </div>
                <button id="submit-a" class="btn mt-2 w-full" disabled>상대방에게 보낼 링크 생성하기</button>
            </div>
        </div>

        <div id="page-a-link" class="page">
            <div class="card text-center">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">링크 생성 완료!</h2>
                <p class="text-gray-600 mb-6">아래 링크를 복사하여 상대방에게 전달해주세요. 상대방이 입장을 작성하면 AI 분석 결과를 확인할 수 있습니다.</p>
                <input id="link-for-b" type="text" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-center" readonly>
                <div class="mt-6 space-x-4">
                    <button id="copy-link" class="btn">링크 복사</button>
                    <button id="start-over-1" class="btn btn-secondary">처음부터 다시하기</button>
                </div>
            </div>
        </div>

        <div id="page-b-input" class="page">
            <div class="card space-y-6">
                 <div class="p-4 bg-slate-50 rounded-lg">
                     <div class="flex items-center space-x-2">
                         <input id="name-me-input-b" class="name-input" value="나">
                         <span class="text-2xl font-bold text-gray-600">의 의견</span>
                         <button id="edit-name-me-b" class="ml-2 p-1 text-gray-400 hover:text-blue-500 hidden">
                             <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>
                         </button>
                     </div>
                 </div>
                <div class="p-4 bg-slate-50 rounded-lg">
                    <h3 class="font-bold text-lg text-gray-700 mb-2"><span id="name-opponent-display-b">상대</span>의 의견</h3>
                    <div id="story-a-display" class="w-full p-3 border border-gray-200 bg-white rounded-lg h-32 overflow-y-auto text-sm"></div>
                </div>
                <textarea id="story-b" class="w-full p-4 border border-gray-300 rounded-lg h-48 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-slate-50" placeholder="여기에 당신의 입장을 입력하세요..."></textarea>
                 <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <label class="flex items-center">
                        <input type="checkbox" id="agree-b" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="ml-3 text-sm text-gray-700">AI 분석 결과, 제가 더 잘못한 것으로 나올 경우 상대방에게 진심어린 사과를 할 것을 약속합니다.</span>
                    </label>
                </div>
                <button id="submit-b" class="btn mt-2 w-full" disabled>AI에게 최종 판단 요청하기</button>
            </div>
        </div>

        <div id="page-loading" class="page">
            <div class="card text-center">
                <div class="flex justify-center items-center mb-6">
                    <div id="loading-spinner" class="w-16 h-16 border-4 border-t-4 rounded-full animate-spin"></div>
                </div>
                <h2 class="text-2xl font-bold text-gray-700">AI가 분석 중입니다...</h2>
                <p class="text-gray-600 mt-2">두 분의 입장을 종합하여 객관적인 판단을 내리고 있습니다. 잠시만 기다려주세요.</p>
            </div>
        </div>

        <div id="page-result" class="page">
            <div class="card">
                <div id="result-title-container" class="text-center mb-8"></div>
                <div id="ai-judgment"></div>
                <div id="result-buttons" class="mt-8 w-full space-y-4 md:space-y-0 md:space-x-4 md:flex">
                    <button id="share-result" class="btn w-full md:w-1/2">결과 공유하기</button>
                    <button id="start-over-2" class="btn btn-secondary w-full md:w-1/2">새로운 분쟁 해결하기</button>
                </div>
            </div>
        </div>
        
        <div id="page-share-link" class="page">
            <div class="card text-center">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">결과 공유 링크</h2>
                <p class="text-gray-600 mb-6">아래 링크를 복사하여 다른 사람에게 공유하면, 현재 AI 분석 결과를 바로 확인할 수 있습니다.</p>
                <input id="share-link-input" type="text" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-center" readonly>
                <div class="mt-6 space-x-4">
                    <button id="copy-share-link" class="btn">링크 복사</button>
                    <button id="back-to-result" class="btn btn-secondary">결과로 돌아가기</button>
                </div>
            </div>
        </div>


        <div id="message-box" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg" style="display: none;"></div>
        <div id="error-box" class="fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg" style="display: none;"></div>

    </div>

    <script>
        // --- DOM Elements ---
        const pages = document.querySelectorAll('.page');
        const storyAInput = document.getElementById('story-a');
        const submitAButton = document.getElementById('submit-a');
        const linkForBInput = document.getElementById('link-for-b');
        const copyLinkButton = document.getElementById('copy-link');
        const storyADisplay = document.getElementById('story-a-display');
        const storyBInput = document.getElementById('story-b');
        const submitBButton = document.getElementById('submit-b');
        const aiJudgmentContainer = document.getElementById('ai-judgment');
        const messageBox = document.getElementById('message-box');
        const errorBox = document.getElementById('error-box');
        const startOverButtons = [document.getElementById('start-over-1'), document.getElementById('start-over-2')];
        const shareResultButton = document.getElementById('share-result');
        const shareLinkInput = document.getElementById('share-link-input');
        const copyShareLinkButton = document.getElementById('copy-share-link');
        const backToResultButton = document.getElementById('back-to-result');
        const nameMeInputA = document.getElementById('name-me-input-a');
        const editNameMeA = document.getElementById('edit-name-me-a');
        const nameOpponentInputA = document.getElementById('name-opponent-input-a');
        const nameMeInputB = document.getElementById('name-me-input-b');
        const editNameMeB = document.getElementById('edit-name-me-b');
        const nameOpponentDisplayB = document.getElementById('name-opponent-display-b');
        const agreeA = document.getElementById('agree-a');
        const agreeB = document.getElementById('agree-b');
        const resultTitleContainer = document.getElementById('result-title-container');

        // --- Global State ---
        let state = {
            nameMe: "나",
            nameOpponent: "상대",
            storyA: "",
            storyB: "",
        };
        
        // --- Utility Functions ---
        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        function showMessage(text, isError = false, duration = 4000) {
            const box = isError ? errorBox : messageBox;
            box.textContent = text;
            box.style.display = 'block';
            setTimeout(() => { box.style.display = 'none'; }, duration);
        }
        
        // --- Core Logic ---
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const p = {
                sA: params.get('sA'),
                sB: params.get('sB'),
                nM: params.get('nM'),
                nO: params.get('nO'),
                sJ: params.get('sJ')
            };

            try {
                if (p.sA && p.sB && p.nM && p.nO && p.sJ) {
                    // Shared result view
                    // For shared results, nameMe (nM) is always A, nameOpponent (nO) is always B.
                    state.nameOpponent = decodeURIComponent(atob(p.nO)); // B's Name
                    state.nameMe = decodeURIComponent(atob(p.nM)); // A's Name
                    const judgmentData = JSON.parse(decodeURIComponent(atob(p.sJ)));
                    aiJudgmentContainer.innerHTML = createResultHtmlFromJson(judgmentData, state.nameMe, state.nameOpponent);
                    resultTitleContainer.innerHTML = createResultTitle(judgmentData, state.nameMe, state.nameOpponent);
                    document.getElementById('main-header').style.display = 'none';
                    // Hide result buttons but show the "start over" button inside the card for shared view
                    document.getElementById('result-buttons').innerHTML = `<button id="start-over-shared" class="btn btn-secondary w-full">새로운 분쟁 해결하기</button>`;
                    document.getElementById('start-over-shared').addEventListener('click', () => { window.location.href = window.location.pathname; });
                    showPage('page-result');

                } else if (p.sA && p.nM && p.nO) {
                    // B's input view
                    state.storyA = decodeURIComponent(atob(p.sA));
                    state.nameMe = decodeURIComponent(atob(p.nO)); // B is now "me"
                    state.nameOpponent = decodeURIComponent(atob(p.nM)); // A is now "opponent"
                    
                    nameMeInputB.value = state.nameMe;
                    nameOpponentDisplayB.textContent = state.nameOpponent;
                    storyADisplay.textContent = state.storyA;
                    showPage('page-b-input');
                } else {
                    showPage('page-a-input');
                }
            } catch (e) {
                console.error("Failed to decode URL params:", e);
                showMessage("잘못된 링크입니다. 처음부터 다시 시작해주세요.", true);
                window.history.replaceState({}, '', window.location.pathname);
                showPage('page-a-input');
            }
        };

        // --- Event Listeners ---
        agreeA.addEventListener('change', () => {
            submitAButton.disabled = !agreeA.checked;
        });

        agreeB.addEventListener('change', () => {
            submitBButton.disabled = !agreeB.checked;
        });

        submitAButton.addEventListener('click', () => {
            state.storyA = storyAInput.value.trim();
            state.nameMe = nameMeInputA.value.trim();
            state.nameOpponent = nameOpponentInputA.value.trim();

            if (!state.storyA || !state.nameMe || !state.nameOpponent) {
                showMessage("이름과 이야기를 모두 입력해주세요.", true);
                return;
            }

            if (state.nameMe === state.nameOpponent) {
                showMessage("서로 다른 이름을 입력해주세요.", true);
                return;
            }

            const encoded = {
                sA: btoa(encodeURIComponent(state.storyA)),
                nM: btoa(encodeURIComponent(state.nameMe)),
                nO: btoa(encodeURIComponent(state.nameOpponent))
            };
            const link = `${window.location.origin}${window.location.pathname}?sA=${encoded.sA}&nM=${encoded.nM}&nO=${encoded.nO}`;
            linkForBInput.value = link;
            showPage('page-a-link');
        });

        submitBButton.addEventListener('click', () => {
            state.storyB = storyBInput.value.trim();
            state.nameMe = nameMeInputB.value.trim(); // Update B's name if edited
            if (!state.storyB) {
                showMessage("당신의 이야기를 입력해주세요.", true);
                return;
            }
            // getAiJudgment expects (storyA, storyB, nameA, nameB)
            // Here, state.nameOpponent is A's name, and state.nameMe is B's name.
            getAiJudgment(state.storyA, state.storyB, state.nameOpponent, state.nameMe); 
        });
        
        startOverButtons.forEach(button => {
            button.addEventListener('click', () => { window.location.href = window.location.pathname; });
        });

        shareResultButton.addEventListener('click', () => {
            const judgmentJson = aiJudgmentContainer.dataset.rawJson;
            // Bug Fix: When sharing, nM should be A's name (state.nameOpponent) and nO should be B's name (state.nameMe).
            const encoded = {
                sA: btoa(encodeURIComponent(state.storyA)),
                sB: btoa(encodeURIComponent(state.storyB)),
                nM: btoa(encodeURIComponent(state.nameOpponent)), // A's name
                nO: btoa(encodeURIComponent(state.nameMe)),       // B's name
                sJ: btoa(encodeURIComponent(judgmentJson))
            };
            const link = `${window.location.origin}${window.location.pathname}?sA=${encoded.sA}&sB=${encoded.sB}&nM=${encoded.nM}&nO=${encoded.nO}&sJ=${encoded.sJ}`;
            shareLinkInput.value = link;
            showPage('page-share-link');
        });
        
        copyLinkButton.addEventListener('click', () => {
            linkForBInput.select();
            try { document.execCommand('copy'); showMessage("링크가 복사되었습니다!"); }
            catch (err) { showMessage("복사에 실패했습니다. 직접 복사해주세요.", true); }
        });

        copyShareLinkButton.addEventListener('click', () => {
            shareLinkInput.select();
            try { document.execCommand('copy'); showMessage("공유 링크가 복사되었습니다!"); }
            catch (err) { showMessage("복사에 실패했습니다. 직접 복사해주세요.", true); }
        });

        backToResultButton.addEventListener('click', () => { showPage('page-result'); });

        // --- Result Page UI Generation ---
        function createResultTitle(data, nameA, nameB) {
            const { responsibilityA, responsibilityB } = data;
            let winner, loser, titleHtml;
            
            if (responsibilityA > responsibilityB) {
                winner = nameA;
                loser = nameB;
                titleHtml = `<h2 class="text-3xl font-bold text-gray-800">이번 분쟁은 <span class="text-blue-600">${winner}</span>의 잘못이 더 크네.</h2>
                             <p class="text-gray-600 mt-2">${loser}한테 진심으로 사과해라.</p>`;
            } else if (responsibilityB > responsibilityA) {
                winner = nameB;
                loser = nameA;
                titleHtml = `<h2 class="text-3xl font-bold text-gray-800">이번 분쟁은 <span class="text-red-600">${winner}</span>의 잘못이 더 크네.</h2>
                             <p class="text-gray-600 mt-2">${loser}한테 진심으로 사과해라.</p>`;
            } else {
                 titleHtml = `<h2 class="text-3xl font-bold text-gray-800">이번 분쟁은 <span class="text-yellow-500">두 분 모두의 잘못</span>이야.</h2>
                              <p class="text-gray-600 mt-2">둘 다 사이좋게 사과하도록.</p>`;
            }
            return titleHtml;
        }

        function createResultHtmlFromJson(data, nameA, nameB) {
            const { responsibilityA, responsibilityB, objective, general, average, statistical, advice } = data;
            
            const analysisCards = [
                { title: '객관적 근거', content: objective, icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>` },
                { title: '일반적 근거', content: general, icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>` },
                { title: '평균적 근거', content: average, icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" /></svg>` },
                { title: '통계적 근거', content: statistical, icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>` }
            ];

            return `
                <div class="space-y-6 bg-slate-100 p-6 rounded-2xl border border-slate-200">
                    <div>
                        <div class="flex items-center justify-between mb-2 text-base font-bold">
                            <span class="text-blue-600">${nameA} 책임</span>
                            <span class="text-red-600">${nameB} 책임</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-8 flex overflow-hidden border-2 border-white shadow-inner">
                            <div class="bg-blue-500 h-full flex items-center justify-center text-white font-bold text-sm" style="width: ${responsibilityA}%">${responsibilityA > 0 ? responsibilityA + '%' : ''}</div>
                            <div class="bg-red-500 h-full flex items-center justify-center text-white font-bold text-sm" style="width: ${responsibilityB}%">${responsibilityB > 0 ? responsibilityB + '%' : ''}</div>
                        </div>
                    </div>
                    ${analysisCards.map(card => `
                    <div class="p-5 bg-white rounded-xl border shadow-sm">
                        <h4 class="text-lg font-bold text-gray-800 mb-3 flex items-center">${card.icon}${card.title}</h4>
                        <div class="text-gray-600 leading-relaxed space-y-2 text-sm">${card.content.replace(/\n/g, '<br>')}</div>
                    </div>
                    `).join('')}
                    <div class="p-5 bg-green-100 rounded-xl border border-green-200 shadow-sm">
                        <h4 class="text-lg font-bold text-green-800 mb-3 flex items-center">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            AI의 조언
                        </h4>
                        <div class="text-green-800 leading-relaxed space-y-2 text-sm">${advice.replace(/\n/g, '<br>')}</div>
                    </div>
                </div>
            `;
        }

        // --- AI API Call ---
        async function getAiJudgment(storyA, storyB, nameA, nameB) {
            showPage('page-loading');
            
            // State update for result sharing
            state.storyA = storyA;
            state.storyB = storyB;
            state.nameOpponent = nameA; // A's name
            state.nameMe = nameB;       // B's name

            const apiKey = "YOUR_GEMINI_API_KEY"; // IMPORTANT: Replace with your actual Gemini API Key
            if (apiKey === "YOUR_GEMINI_API_KEY") {
                 showMessage("Gemini API 키를 입력해주세요. (JAVASCRIPT 427번째 줄)", true, 10000);
                 showPage('page-b-input');
                 return;
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

            const prompt = `
너는 싸움 구경을 제일 좋아하는 친구야. 아주 솔직하고 직설적으로, 반말로 두 사람의 분쟁을 분석해줘.
${nameA}와 ${nameB} 사이의 문제인데, 누가 더 잘못했는지, 왜 그렇게 생각하는지 가감없이 말해줘.
책임 비율(responsibilityA, responsibilityB)은 합쳐서 100이 되도록 정해줘.
답변은 반드시 다음 JSON 형식에 맞춰서, 다른 설명 없이 JSON 객체만 반환해야 해.
JSON 내부의 모든 텍스트는 반드시 반말로 작성하고, 'A', 'B' 대신에 '${nameA}', '${nameB}'라는 실제 이름을 사용해줘.

{
  "responsibilityA": 0,
  "responsibilityB": 0,
  "objective": "객관적인 사실만 놓고 봤을 때 상황이 어떤지 분석해줘.",
  "general": "보통 사람들, 그러니까 내 주변 친구들 같으면 이 상황을 어떻게 볼 것 같은지 말해줘.",
  "average": "보통 이런 비슷한 싸움에서는 평균적으로 누가 더 잘못하는 경우가 많은지 알려줘.",
  "statistical": "통계까지는 아니더라도, 확률적으로 봤을 때 누가 더 문제의 원인일 가능성이 높은지 말해줘.",
  "advice": "그래서 결론적으로, 두 사람이 앞으로 어떻게 하면 좋을지 조언해줘."
}

---
### 분쟁 내용
**${nameA}의 의견:**
${storyA}

**${nameB}의 의견:**
${storyB}
`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { 
                    responseMimeType: "application/json",
                }
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorResult = await response.json();
                    console.error("API Error Body:", errorResult);
                    const errorMessage = errorResult?.error?.message || `API 요청 실패: ${response.status}`;
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                    throw new Error("AI로부터 유효한 응답을 받지 못했습니다.");
                }

                const judgmentJsonText = candidate.content.parts[0].text;
                const judgmentData = JSON.parse(judgmentJsonText);
                
                aiJudgmentContainer.dataset.rawJson = judgmentJsonText;
                aiJudgmentContainer.innerHTML = createResultHtmlFromJson(judgmentData, nameA, nameB);
                resultTitleContainer.innerHTML = createResultTitle(judgmentData, nameA, nameB);

                showPage('page-result');

            } catch (error) {
                console.error("AI 판단 요청 중 오류 발생:", error);
                showMessage(`AI 분석 중 오류가 발생했습니다: ${error.message}`, true, 6000);
                showPage('page-b-input'); // Go back to the input page on error
            }
        }
    </script>
</body>
</html>
